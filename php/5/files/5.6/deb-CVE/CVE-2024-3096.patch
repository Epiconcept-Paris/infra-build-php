From: Markus Koschany <apo@debian.org>
Date: Sat, 11 May 2024 10:00:38 +0200
Subject: CVE-2024-3096

Upstream-Advisory: https://github.com/php/php-src/security/advisories/GHSA-h746-cjrr-wfmr
Origin: https://github.com/php/php-src/commit/0ba5229a3f7572846e91c8f5382e87785f543826
---
 ext/standard/password.c                                 | 5 ++++-
 ext/standard/tests/password/password_bcrypt_errors.phpt | 4 ++++
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/ext/standard/password.c b/ext/standard/password.c
index 5a8edad..abec4a2 100644
--- a/ext/standard/password.c
+++ b/ext/standard/password.c
@@ -322,7 +322,10 @@ PHP_FUNCTION(password_hash)
 		case PHP_PASSWORD_BCRYPT:
 		{
 			long cost = PHP_PASSWORD_BCRYPT_COST;
-	
+			if (memchr(password, '\0', password_len)) {
+				php_error_docref(NULL TSRMLS_CC, E_WARNING, "Bcrypt password must not contain null character");
+				RETURN_NULL();
+			}
 			if (options && zend_symtable_find(options, "cost", 5, (void **) &option_buffer) == SUCCESS) {
 				if (Z_TYPE_PP(option_buffer) != IS_LONG) {
 					zval cast_option_buffer;
diff --git a/ext/standard/tests/password/password_bcrypt_errors.phpt b/ext/standard/tests/password/password_bcrypt_errors.phpt
index 2548c9a..617f468 100644
--- a/ext/standard/tests/password/password_bcrypt_errors.phpt
+++ b/ext/standard/tests/password/password_bcrypt_errors.phpt
@@ -16,6 +16,8 @@ var_dump(password_hash("foo", PASSWORD_BCRYPT, array("salt" => 123)));
 
 var_dump(password_hash("foo", PASSWORD_BCRYPT, array("cost" => "foo")));
 
+var_dump(password_hash("null\0password", PASSWORD_BCRYPT));
+
 ?>
 --EXPECTF--
 Warning: password_hash(): Invalid bcrypt cost parameter specified: 3 in %s on line %d
@@ -36,4 +38,6 @@ NULL
 Warning: password_hash(): Invalid bcrypt cost parameter specified: 0 in %s on line %d
 NULL
 
+Warning: password_hash(): Bcrypt password must not contain null character in %s on line %d
+NULL
 
