Origin: https://github.com/php/php-src/commit/a5538c62293fa782fcc382d0635cfc0c8b9190e3
Origin: https://github.com/php/php-src/commit/190013787bbc424c240413d914e3a038f974ccef
Reviewed-by: Sylvain Beucler <beuc@debian.org>
Last-Update: 2021-07-12

From a5538c62293fa782fcc382d0635cfc0c8b9190e3 Mon Sep 17 00:00:00 2001
From: "Christoph M. Becker" <cmbecker69@gmx.de>
Date: Mon, 14 Jun 2021 13:22:27 +0200
Subject: [PATCH] Fix #81122: SSRF bypass in FILTER_VALIDATE_URL

We need to ensure that the password detected by parse_url() is actually
a valid password; we can re-use is_userinfo_valid() for that.

From 190013787bbc424c240413d914e3a038f974ccef Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sun, 27 Jun 2021 21:57:58 -0700
Subject: [PATCH] Fix warning

Index: php5-5.6.40+dfsg/ext/filter/logical_filters.c
===================================================================
--- php5-5.6.40+dfsg.orig/ext/filter/logical_filters.c
+++ php5-5.6.40+dfsg/ext/filter/logical_filters.c
@@ -515,7 +515,9 @@ bad_url:
 		RETURN_VALIDATION_FAILED
 	}
 
-	if (url->user != NULL && !is_userinfo_valid(url->user)) {
+	if ((url->user != NULL && !is_userinfo_valid(url->user))
+		|| (url->pass != NULL && !is_userinfo_valid(url->pass))
+	) {
 		php_url_free(url);
 		RETURN_VALIDATION_FAILED
 
Index: php5-5.6.40+dfsg/ext/filter/tests/bug81122.phpt
===================================================================
--- /dev/null
+++ php5-5.6.40+dfsg/ext/filter/tests/bug81122.phpt
@@ -0,0 +1,21 @@
+--TEST--
+Bug #81122 (SSRF bypass in FILTER_VALIDATE_URL)
+--SKIPIF--
+<?php
+if (!extension_loaded('filter')) die("skip filter extension not available");
+?>
+--FILE--
+<?php
+$urls = [
+    "https://example.com:\\@test.com/",
+    "https://user:\\epass@test.com",
+    "https://user:\\@test.com",
+];
+foreach ($urls as $url) {
+    var_dump(filter_var($url, FILTER_VALIDATE_URL));
+}
+?>
+--EXPECT--
+bool(false)
+bool(false)
+bool(false)
