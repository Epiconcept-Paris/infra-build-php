Origin: https://github.com/php/php-src/commit/7355ab81763a3d6a04ac11660e6a16d58838d187
Reviewed-by: Sylvain Beucler <beuc@debian.org>
Last-Update: 2021-07-09

From 7355ab81763a3d6a04ac11660e6a16d58838d187 Mon Sep 17 00:00:00 2001
From: "Christoph M. Becker" <cmbecker69@gmx.de>
Date: Tue, 14 Jul 2020 17:04:24 +0200
Subject: [PATCH] Fix #79797: Use of freed hash key in the phar_parse_zipfile
 function

We must not use heap memory after we freed it.
---
 ext/phar/tests/bug79797.phar | Bin 0 -> 274 bytes
 ext/phar/tests/bug79797.phpt |  14 ++++++++++++++
 ext/phar/zip.c               |   2 +-
 3 files changed, 15 insertions(+), 1 deletion(-)
 create mode 100644 ext/phar/tests/bug79797.phar
 create mode 100644 ext/phar/tests/bug79797.phpt

Index: php5-5.6.40+dfsg/ext/phar/tests/bug79797.phpt
===================================================================
--- /dev/null
+++ php5-5.6.40+dfsg/ext/phar/tests/bug79797.phpt
@@ -0,0 +1,14 @@
+--TEST--
+Bug #79797 (Use of freed hash key in the phar_parse_zipfile function)
+--SKIPIF--
+<?php
+if (!extension_loaded('phar')) die('skip phar extension not available');
+?>
+--INI--
+phar.cache_list={PWD}/bug79797.phar
+--FILE--
+<?php
+echo "done\n";
+?>
+--EXPECT--
+done
Index: php5-5.6.40+dfsg/ext/phar/zip.c
===================================================================
--- php5-5.6.40+dfsg.orig/ext/phar/zip.c
+++ php5-5.6.40+dfsg/ext/phar/zip.c
@@ -682,7 +682,7 @@ foundit:
 			efree(actual_alias);
 		}
 
-		zend_hash_add(&(PHAR_GLOBALS->phar_alias_map), actual_alias, mydata->alias_len, (void*)&mydata, sizeof(phar_archive_data*), NULL);
+		zend_hash_add(&(PHAR_GLOBALS->phar_alias_map), mydata->alias, mydata->alias_len, (void*)&mydata, sizeof(phar_archive_data*), NULL);
 	} else {
 		phar_archive_data **fd_ptr;
 
